<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Ticker</title>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 12px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .positive {
      color: green;
    }
    .negative {
      color: red;
    }
    input, button {
      padding: 8px;
      margin: 5px;
    }
    button {
      cursor: pointer;
    }
    #connection-status {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .connected {
      background-color: #d4edda;
      color: #155724;
    }
    .disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <h1>Crypto Ticker</h1>
  
  <div id="connection-status" class="disconnected">Disconnected from server</div>

  <!-- Form to subscribe to cryptocurrency and input buying data -->
  <div>
    <label for="cryptoSymbol">Crypto Symbol: </label>
    <input type="text" id="cryptoSymbol" placeholder="e.g., bitcoin, ethereum" required />
    
    <label for="buyPrice">Buy Price (USD): </label>
    <input type="number" id="buyPrice" placeholder="Enter buy price" min="0" step="0.000001" required />
    
    <label for="quantity">Quantity: </label>
    <input type="number" id="quantity" placeholder="Enter quantity" min="0" step="0.000001" required />
    
    <button onclick="subscribe()">Subscribe</button>
    <span id="error-message" style="color: red;"></span>
  </div>

  <h2>Your Subscribed Cryptos</h2>

  <!-- Table to display the crypto data -->
  <table>
    <thead>
      <tr>
        <th>Cryptocurrency</th>
        <th>Current Price (USD)</th>
        <th>Buy Price (USD)</th>
        <th>Quantity</th>
        <th>Profit/Loss (USD)</th>
        <th>Profit/Loss (%)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="crypto-list">
      <!-- Data will be dynamically inserted here -->
    </tbody>
  </table>

  <script>
    let socket;
    const cryptoList = document.getElementById('crypto-list');
    const cryptoSymbolInput = document.getElementById('cryptoSymbol');
    const buyPriceInput = document.getElementById('buyPrice');
    const quantityInput = document.getElementById('quantity');
    const errorMessage = document.getElementById('error-message');
    const connectionStatus = document.getElementById('connection-status');
    const subscriptions = new Set();
    const userCryptoData = {}; // Store user data for each cryptocurrency

    // Initialize WebSocket connection
    function connectWebSocket() {
      socket = new WebSocket('ws://localhost:8080');

      socket.onopen = () => {
        connectionStatus.textContent = 'Connected to server';
        connectionStatus.className = 'connected';
        console.log('WebSocket connected');
        
        // Resubscribe to all cryptocurrencies if reconnecting
        subscriptions.forEach(symbol => {
          socket.send(JSON.stringify({
            action: 'subscribe',
            stock: symbol.toLowerCase()
          }));
        });
      };

      socket.onclose = () => {
        connectionStatus.textContent = 'Disconnected from server - attempting to reconnect...';
        connectionStatus.className = 'disconnected';
        console.log('WebSocket disconnected');
        setTimeout(connectWebSocket, 5000); // Attempt reconnect after 5 seconds
      };

      socket.onerror = (error) => {
        console.error('WebSocket error:', error);
        connectionStatus.textContent = 'Connection error';
        connectionStatus.className = 'disconnected';
      };

      // Listen for incoming messages from the server
      socket.onmessage = (event) => {
        try {
          const cryptoUpdate = JSON.parse(event.data);
          if (cryptoUpdate.message) {
            console.log(cryptoUpdate.message); // Log welcome message
          } else {
            const symbol = cryptoUpdate.symbol;
            const price = parseFloat(cryptoUpdate.price);

            // Update the table row for each subscribed cryptocurrency
            updateTableRow(symbol, price);
          }
        } catch (e) {
          console.error('Error parsing message:', e);
        }
      };
    }

    // Start the initial connection
    connectWebSocket();

    // Subscribe to a cryptocurrency entered by the user
    function subscribe() {
  errorMessage.textContent = '';
  const cryptoSymbol = cryptoSymbolInput.value.trim().toLowerCase();
  const buyPrice = parseFloat(buyPriceInput.value);
  const quantity = parseFloat(quantityInput.value);

  // Validate inputs
  if (!cryptoSymbol) {
    errorMessage.textContent = 'Please enter a cryptocurrency symbol';
    return;
  }

  if (isNaN(buyPrice) || buyPrice <= 0) {
    errorMessage.textContent = 'Please enter a valid buy price greater than 0';
    return;
  }

  if (isNaN(quantity) || quantity <= 0) {
    errorMessage.textContent = 'Please enter a valid quantity greater than 0';
    return;
  }

  if (subscriptions.has(cryptoSymbol)) {
    errorMessage.textContent = `You're already subscribed to ${cryptoSymbol}`;
    return;
  }

  // Send subscription message with all required fields
  if (socket.readyState === WebSocket.OPEN) {
    socket.send(JSON.stringify({
      action: 'subscribe',
      stock: cryptoSymbol,
      buyPrice: buyPrice,
      quantity: quantity
    }));

    subscriptions.add(cryptoSymbol);
    userCryptoData[cryptoSymbol] = { buyPrice, quantity };
    addTableRow(cryptoSymbol, buyPrice, quantity);
    
    // Clear inputs
    cryptoSymbolInput.value = '';
    buyPriceInput.value = '';
    quantityInput.value = '';
  } else {
    errorMessage.textContent = 'Not connected to server';
  }
}
    // Unsubscribe from a cryptocurrency
    function unsubscribe(symbol) {
      if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
          action: 'unsubscribe',
          stock: symbol.toLowerCase()
        }));
      }

      subscriptions.delete(symbol);

      const row = document.getElementById(`crypto-${symbol}`);
      if (row) {
        row.remove();
      }

      // Remove user data for the unsubscribed crypto
      delete userCryptoData[symbol];
    }

    // Add a new row to the table
    function addTableRow(symbol, buyPrice, quantity) {
      const row = document.createElement('tr');
      row.id = `crypto-${symbol}`;

      row.innerHTML = `
        <td>${symbol.toUpperCase()}</td>
        <td id="current-price-${symbol}">-</td>
        <td>$${buyPrice.toFixed(6)}</td>
        <td>${quantity.toFixed(6)}</td>
        <td id="profit-loss-${symbol}">-</td>
        <td id="profit-loss-percent-${symbol}">-</td>
        <td><button onclick="unsubscribe('${symbol}')">Unsubscribe</button></td>
      `;

      cryptoList.appendChild(row);
    }

    // Update the table with new data (price, profit/loss, etc.)
    function updateTableRow(symbol, currentPrice) {
      const userData = userCryptoData[symbol];
      if (!userData) return;

      // Update the current price in user data
      userData.currentPrice = currentPrice;

      const { buyPrice, quantity } = userData;

      // Update the current price display
      const priceCell = document.getElementById(`current-price-${symbol}`);
      if (priceCell) {
        priceCell.textContent = `$${currentPrice.toFixed(6)}`;
      }

      // Calculate profit/loss
      const currentValue = currentPrice * quantity;
      const initialValue = buyPrice * quantity;
      const dollarChange = currentValue - initialValue;
      const percentChange = (dollarChange / initialValue) * 100;

      // Update the profit/loss cells
      const profitLossCell = document.getElementById(`profit-loss-${symbol}`);
      if (profitLossCell) {
        profitLossCell.textContent = `$${dollarChange.toFixed(2)}`;
        profitLossCell.className = dollarChange >= 0 ? 'positive' : 'negative';
      }

      const profitLossPercentCell = document.getElementById(`profit-loss-percent-${symbol}`);
      if (profitLossPercentCell) {
        profitLossPercentCell.textContent = `${percentChange.toFixed(2)}%`;
        profitLossPercentCell.className = percentChange >= 0 ? 'positive' : 'negative';
      }
    }
  </script>
</body>
</html>